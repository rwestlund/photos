<!--
    Copyright (c) 2016-2017, Randy Westlund and Jacqueline Kory Westlund.
    All rights reserved.
    This code is under the BSD-2-Clause license.
-->

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/polymer-responsive-dialog/responsive-dialog.html">
<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="form-behavior.html">

<dom-module id="photo-form">
    <template>
        <style include="iron-flex iron-flex-alignment"></style>
        <style>
            .photo-item-label {
                padding-top: 1.2em;
                display: block;
            }
            .album-item {
                margin-right: 1em;
                padding-right: 1em;
            }
        </style>

        <iron-ajax
            auto
            method="GET"
            url="/api/albums"
            handle-as="json"
            last-response="{{albums}}">
        </iron-ajax>

        <responsive-dialog id="dialog"
                title="Edit photo"
                dismiss-text="Cancel"
                confirm-text="Save"
                on-iron-overlay-closed="resolve_dialog">
            <paper-input
                    type="text"
                    label="Caption"
                    value="{{photo.caption}}"
                    autocapitalize="sentences"
                    char-counter maxlength="140">
            </paper-input>

            <strong class="photo-item-label">Albums</strong>
                <div class="layout horizontal wrap">
                    <template is="dom-repeat" items="[[photo.albums]]">
                        <paper-material class="album-item">
                            <paper-icon-button
                                    icon="icons:cancel"
                                    data-index$="[[index]]"
                                    on-tap="remove_album">
                            </paper-icon-button>
                            <span>[[item]]</span>
                        </paper-material>
                    </template>
                </div>

            <div class="layout vertical">
                <paper-dropdown-menu
                        label="Select Albums"
                        vertical-align="top"
                        horizontal-align="right">
                    <paper-listbox class="dropdown-content"
                                attr-for-selected="value"
                                selected="{{selected_album}}"
                                on-iron-select="add_selected_album">
                        <template is="dom-repeat" items="[[albums]]">
                            <paper-item value="[[item.name]]">
                                [[item.name]]
                            </paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
            </div>
        </responsive-dialog>
    </template>

    <script>
        'use strict';
        Polymer({
            is: "photo-form",
            behaviors: [ photo_behaviors.form_behavior ],
            properties: {
                photo: {
                    type: Object,
                },
            },
            // Add an album to the album list, checking for duplicates first.
            add_selected_album: function() {
                for (var i in this.photo.albums)
                    if (this.photo.albums[i] === this.selected_album) return;
                this.push('photo.albums', this.selected_album);
            },
            remove_album: function(e) {
                var index = Number(
                        e.currentTarget.attributes['data-index'].value);
                this.splice('photo.albums', index, 1);
            },
        })
    </script>
</dom-module>
