<!--
    Copyright (c) 2016-2017, Randy Westlund and Jacqueline Kory Westlund.
    All rights reserved.
    This code is under the BSD-2-Clause license.
-->

<link rel="import" href="../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="cookie-display.html">
<link rel="import" href="global-behavior.html">
<link rel="import" href="global-styles.html">
<link rel="import" href="photo-display.html">

<dom-module id="photo-collection">
    <template>
        <style include="app-grid-style"></style>
        <style include="iron-flex iron-flex-alignment"></style>
        <style include="global-styles"></style>
        <style>
            :host {
                display: block;
                    --app-grid-columns: 2;
                    --app-grid-gutter: 15px;
            }
            @media (max-width: 800px) {
                :host {
                    --app-grid-columns: 1;
                }
            }
            span.album_image_count {
                color: gray;
                font-size: large;
                font-style: italic;
            }
        </style>

        <cookie-display cookie-name="role" cookie-value="{{user_role}}">
        </cookie-display>

        <iron-ajax
            auto
            method="GET"
            url="/api/photos"
            params="[[search_filter]]"
            handle-as="json"
            last-response="{{photos}}">
        </iron-ajax>

         <template is="dom-if" if="[[albumName]]">
            <iron-ajax
                auto="[[albumName]]"
                method="GET"
                url="/api/albums/[[albumName]]"
                handle-as="json"
                last-response="{{album}}">
            </iron-ajax>

            <iron-ajax id="put_ajax"
                    method="PUT"
                    url="/api/albums/[[albumName]]"
                    body="[[item_to_edit]]"
                    content-type="application/json"
                    handle-as="json"
                    last-response="{{item_to_edit}}"
                    on-response="put_item_successful"
                    on-error="put_item_failed"
                    loading="{{loading}}">
             </iron-ajax>

            <div class="layout horizontal justified">
                <div>
                    <span class="page_name">[[albumName]]</span>
                    <template is="dom-if" if="[[user_is_admin(user_role)]]">
                        <paper-icon-button icon="icons:create"
                                on-tap="edit_album">
                        </paper-icon-button>
                        <paper-spinner active="[[loading]]"></paper-spinner>
                    </template>
                </div>
                <span class="album_image_count">
                    [[pretty_image_count(album.image_count)]]
                </span>
            </div>
        </template>

        <template is="dom-if" if="[[!photos.length]]">
            <h4>This album has no photos!</h4>
        </template>

        <div class="app-grid">
            <template is="dom-if" if="[[albumName]]">
                <template is="dom-repeat" items="[[photos]]">
                    <photo-display photo="[[item]]" album
                            on-set-album-image="set_album_image"
                            on-expand-photo="show_big_thumbnail">
                    </photo-display>
                </template>
            </template>
            <template is="dom-if" if="[[!albumName]]">
                <template is="dom-repeat" items="[[photos]]">
                    <photo-display photo="[[item]]"
                            on-expand-photo="show_big_thumbnail">
                    </photo-display>
                </template>
            </template>
        </div>
    </template>

    <script>
        'use strict';
        Polymer({
            is: "photo-collection",
            behaviors: [photo_behaviors.global_behavior],
            properties: {
                albumName: {
                    type: String,
                    value: "",
                },
                search_filter: {
                    type: Object,
                    computed: "compute_search_filter(albumName)",
                }
            },
            compute_search_filter: function(album) {
                var o = {};
                if (album) o.album= album;
                return o;
            },
            // Reevaluated the app-grid styles on resize.
            attached: function() {
                window.addEventListener("resize", () => this.updateStyles());
            },
            edit_album: function() {
                this.set('item_to_edit', JSON.parse(JSON.stringify(this.album)));
                // Ask for the form to be opened.
                window.dispatchEvent(new CustomEvent("open-form", {
                    detail: {
                        name: "edit_album_form",
                        album: this.item_to_edit,
                        callback: "resolve_edit_album",
                        that: this,
                    },
                }));
            },
            resolve_edit_album: function (e, reason) {
                if(!reason.confirmed) return;
                // Override dirty checking; let Polymer know it changed.
                var tmp = this.item_to_edit;
                this.set("item_to_edit", {});
                this.set("item_to_edit", tmp);
                this.$$("#put_ajax").generateRequest();
            },
            put_item_successful: function() {
                console.log("updated");
                if (this.albumName !== this.item_to_edit.name)
                {
                    window.history.pushState({}, null, "/albums/" +
                            this.item_to_edit.name);
                    window.dispatchEvent(new CustomEvent("location-changed"));
                }
            },
            put_item_failed: function() {
                console.log("failed to update")
            },
            set_album_image: function(e) {
                this.set('item_to_edit', JSON.parse(JSON.stringify(this.album)));
                this.item_to_edit.cover_image_id = e.detail;
                this.$$("#put_ajax").generateRequest();
            },
            // Opens the big thumbnail display.
            show_big_thumbnail: function(e) {
                // Ask for the big thumbnail display to be opened.
                window.dispatchEvent(new CustomEvent("open-form", {
                    detail: {
                        name: "expand_photo_form",
                        photoId: e.detail,
                        photoList: this.photos,
                    },
                }));
            },
        })
    </script>
</dom-module>
