<!--
    Copyright (c) 2016. Randy Westlund and Jacqueline Kory Westlund.
    All rights reserved.
    This code is under the BSD-2-Clause license.
-->

<!-- Polymer library components. -->
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<!-- Third party components. -->
<link rel="import" href="../bower_components/polymer-responsive-dialog/responsive-dialog.html">

<!-- Behaviors must come before elements that use them. -->
<link rel="import" href="form-behavior.html">

<!-- Custom elements. -->
<link rel="import" href="photos-uploads.html">
<link rel="import" href="photo-collection.html">
<link rel="import" href="photo-display.html">
<link rel="import" href="photos-forms.html">
<link rel="import" href="photo-form.html">
<link rel="import" href="tag-form.html">
<link rel="import" href="cookie-display.html">
<link rel="import" href="tag-collection.html">
<link rel="import" href="tag-display.html">

<dom-module id="photos-app">
  <template>
    <style>
        :host {
            display: block;
            --app-primary-color: #433262;
            --app-secondary-color: #f5d322;
            --app-accent-color: #171717;

            /* app-drawer */
            --app-drawer-width: 10em;

            /* paper-menu */
            --paper-menu-background-color: #f2e4d2;

            --app-drawer-content-container: {
                background-color: #f2e4d2;
            }
        }

        app-toolbar {
            background-color: #1E88E5;
        }

        paper-menu iron-icon {
            margin-right: 1em;
        }

        paper-menu a {
            text-decoration: none;
            color: #111111;
        }

        span.username {
            padding-left: 5px;
        }
    </style>

    <iron-ajax id="post_ajax"
                method="POST"
                url="/api/tags"
                body="[[item_to_edit]]"
                content-type="application/json"
                handle-as="json"
                last-response="{{item_to_edit}}"
                on-response="post_item_successful"
                on-error="post_item_failed"
                loading="{{loading}}">
    </iron-ajax>

    <cookie-display cookie-name="username" cookie-value="{{user_name}}">
    </cookie-display>

    <iron-media-query query="(max-width: 500px)" query-matches="{{mobile}}">
    </iron-media-query>

    <app-drawer-layout fullbleed responsive-width="900px">
        <app-drawer id="drawer" swipe-open>
            <app-toolbar></app-toolbar>
            <paper-menu>
                <a href="/"><paper-item>
                        <iron-icon icon="image:landscape"></iron-icon>
                        Recent
                    </paper-item>
                </a>
                <a href="/albums/"><paper-item>
                        <iron-icon icon="image:photo-library"></iron-icon>
                        Albums
                    </paper-item>
                </a>

                <a href="/about/">
                    <paper-item>
                        <iron-icon icon="icons:info"></iron-icon>
                        About
                    </paper-item>
                </a>
                <template is="dom-if" if="[[user_name]]">
                    <a href="/users/">
                        <paper-item>
                            <iron-icon icon="icons:face"></iron-icon>
                            Users
                        </paper-item>
                    </a>
                    <a href="/uploads/">
                        <paper-item>
                            <iron-icon icon="icons:file-upload"></iron-icon>
                            Uploads
                        </paper-item>
                    </a>
                </template>
            </paper-menu>
            <hr>
            <template is="dom-if" if="[[user_name]]">
                <paper-button raised on-tap="create_tag">
                    <iron-icon icon="icons:add"></iron-icon>
                    Create tag
                </paper-button>
                <paper-spinner active="[[loading]]">
                </paper-spinner>
            </template>

            <hr>
            <paper-menu>
            <template is="dom-if" if="[[!user_name]]">
                <a href="/auth/google/login">
                    <paper-item>
                        <iron-icon icon="icons:account-circle"></iron-icon>
                        Sign In
                    </paper-item>
                </a>
            </template>
            <template is="dom-if" if="[[user_name]]">
                <a href="/auth/logout">
                    <paper-item>
                       <iron-icon icon="maps:directions-run"></iron-icon>
                       Logout
                    </paper-item>
                </a>
            </template>
            </paper-menu>

        </app-drawer>

        <app-header-layout fullbleed>
            <app-header fixed>
                <app-toolbar>
                    <paper-icon-button icon="menu" drawer-toggle>
                    </paper-icon-button>
                    <div main-title>Photos</div>
                    <template is="dom-if" if="[[!mobile]]">
                        <template is="dom-if" if="[[user_name]]">
                            <iron-icon icon="icons:account-circle"></iron-icon>
                            <span class="username">Hi, [[user_name]]!</span>
                        </template>
                    </template>
                </app-toolbar>
            </app-header>

            <!-- Ignore /api/ and /auth/ routes; let the browser have them. This
                 is also defined in sw-precache-config.js. -->
            <app-location route="{{route}}" url-space-regex="^/(?!(api|auth)/)">
            </app-location>
            <!-- The top-level router. -->
            <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{route_data}}"
                tail="{{tail}}">
            </app-route>

            <!-- If every page used the same subrouter, they'd all be bound
             to the same id (i.e. loading albums/test would also try to
             load otherurl/test). Instead, use a separate router for each path
             so that a non-active path will not match the id from the
             current path. There may be a better way to do this. -->
            <app-route
                 route="{{route}}"
                 pattern="/albums/:tag"
                 data="{{albums_route_data}}">
            </app-route>

            <iron-pages selected="[[route_data.page]]"
                attr-for-selected="name"
                fallback-selection="404">

                <section name="">
                    <h2>photos!</h2>
                    <photo-collection>
                    </photo-collection>
                </section>

                <section name="albums">
                    <template is="dom-if" if="[[albums_route_data.tag]]">
                        <photo-collection tag="[[albums_route_data.tag]]">
                        </photo-collection>
                    </template>

                    <template is="dom-if" if="[[!albums_route_data.tag]]">
                        <h2>albums!</h2>
                        <tag-collection></tag-collection>
                    </template>
                </section>

                <section name="about">
                    <h2>about!</h2>
                </section>

                <section name="users">
                    <h2>users!</h2>
                </section>

                <section name="uploads">
                    <photos-uploads></photos-uploads>
                </section>

                <section name="404">
                    <h2>404!</h2>
                </section>

            </iron-pages>
        </app-header-layout>
    </app-drawer-layout>

    <photos-forms></photos-forms>

  </template>

  <script>
    'use strict';
    Polymer({

      is: 'photos-app',

      properties: {
        prop1: {
          type: String,
          value: 'photos-app--------------------!',
        },
      },

      ready: function() {
          console.log("ready");
      },

      toggle_drawer: function() {
          this.$.drawer.toggle();
      },

      // Opens the create tag modal.
      create_tag: function() {
          this.set('item_to_edit', {});
          // Ask for the form to be opened.
          this.fire("iron-signal", { name: "open-form",
              data: {
                  name: "create_tag_form",
                  tag: this.item_to_edit,
                  callback: "resolve_create_tag",
                  that: this,
              },
          });
      },

      // Handle response from dialog. Reason is either confirmed or
      // canceled.
      resolve_create_tag: function(e, reason) {
          if(!reason.confirmed) return;
          // Override dirty checking; let Polymer know it changed.
          var tmp = this.item_to_edit;
          this.set("item_to_edit", {});
          this.set("item_to_edit", tmp);
          this.$.post_ajax.generateRequest();
      },

      post_item_successful: function() {
          console.log("updated");
      },
      post_item_failed: function() {
          console.log("failed to update")
      }


    });
  </script>
</dom-module>
